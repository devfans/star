"use strict";function md5(e){var i="0123456789abcdef";function t(e){for(var t="",n=0;n<=3;n++)t+=i.charAt(e>>8*n+4&15)+i.charAt(e>>8*n&15);return t}function o(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function r(e,t,n,i,a,s){return o((t=o(o(t,e),o(i,s)))<<a|t>>>32-a,n)}function n(e,t,n,i,a,s,o){return r(t&n|~t&i,e,t,a,s,o)}function a(e,t,n,i,a,s,o){return r(t&i|n&~i,e,t,a,s,o)}function s(e,t,n,i,a,s,o){return r(t^n^i,e,t,a,s,o)}function h(e,t,n,i,a,s,o){return r(n^(t|~i),e,t,a,s,o)}for(var c,l,d,g,u=function(e){for(var t=1+(e.length+8>>6),n=new Array(16*t),i=0;i<16*t;i++)n[i]=0;for(i=0;i<e.length;i++)n[i>>2]|=e.charCodeAt(i)<<i%4*8;return n[i>>2]|=128<<i%4*8,n[16*t-2]=8*e.length,n}(""+e),m=1732584193,_=-271733879,p=-1732584194,y=271733878,w=0;w<u.length;w+=16)m=n(c=m,l=_,d=p,g=y,u[w+0],7,-680876936),y=n(y,m,_,p,u[w+1],12,-389564586),p=n(p,y,m,_,u[w+2],17,606105819),_=n(_,p,y,m,u[w+3],22,-1044525330),m=n(m,_,p,y,u[w+4],7,-176418897),y=n(y,m,_,p,u[w+5],12,1200080426),p=n(p,y,m,_,u[w+6],17,-1473231341),_=n(_,p,y,m,u[w+7],22,-45705983),m=n(m,_,p,y,u[w+8],7,1770035416),y=n(y,m,_,p,u[w+9],12,-1958414417),p=n(p,y,m,_,u[w+10],17,-42063),_=n(_,p,y,m,u[w+11],22,-1990404162),m=n(m,_,p,y,u[w+12],7,1804603682),y=n(y,m,_,p,u[w+13],12,-40341101),p=n(p,y,m,_,u[w+14],17,-1502002290),m=a(m,_=n(_,p,y,m,u[w+15],22,1236535329),p,y,u[w+1],5,-165796510),y=a(y,m,_,p,u[w+6],9,-1069501632),p=a(p,y,m,_,u[w+11],14,643717713),_=a(_,p,y,m,u[w+0],20,-373897302),m=a(m,_,p,y,u[w+5],5,-701558691),y=a(y,m,_,p,u[w+10],9,38016083),p=a(p,y,m,_,u[w+15],14,-660478335),_=a(_,p,y,m,u[w+4],20,-405537848),m=a(m,_,p,y,u[w+9],5,568446438),y=a(y,m,_,p,u[w+14],9,-1019803690),p=a(p,y,m,_,u[w+3],14,-187363961),_=a(_,p,y,m,u[w+8],20,1163531501),m=a(m,_,p,y,u[w+13],5,-1444681467),y=a(y,m,_,p,u[w+2],9,-51403784),p=a(p,y,m,_,u[w+7],14,1735328473),m=s(m,_=a(_,p,y,m,u[w+12],20,-1926607734),p,y,u[w+5],4,-378558),y=s(y,m,_,p,u[w+8],11,-2022574463),p=s(p,y,m,_,u[w+11],16,1839030562),_=s(_,p,y,m,u[w+14],23,-35309556),m=s(m,_,p,y,u[w+1],4,-1530992060),y=s(y,m,_,p,u[w+4],11,1272893353),p=s(p,y,m,_,u[w+7],16,-155497632),_=s(_,p,y,m,u[w+10],23,-1094730640),m=s(m,_,p,y,u[w+13],4,681279174),y=s(y,m,_,p,u[w+0],11,-358537222),p=s(p,y,m,_,u[w+3],16,-722521979),_=s(_,p,y,m,u[w+6],23,76029189),m=s(m,_,p,y,u[w+9],4,-640364487),y=s(y,m,_,p,u[w+12],11,-421815835),p=s(p,y,m,_,u[w+15],16,530742520),m=h(m,_=s(_,p,y,m,u[w+2],23,-995338651),p,y,u[w+0],6,-198630844),y=h(y,m,_,p,u[w+7],10,1126891415),p=h(p,y,m,_,u[w+14],15,-1416354905),_=h(_,p,y,m,u[w+5],21,-57434055),m=h(m,_,p,y,u[w+12],6,1700485571),y=h(y,m,_,p,u[w+3],10,-1894986606),p=h(p,y,m,_,u[w+10],15,-1051523),_=h(_,p,y,m,u[w+1],21,-2054922799),m=h(m,_,p,y,u[w+8],6,1873313359),y=h(y,m,_,p,u[w+15],10,-30611744),p=h(p,y,m,_,u[w+6],15,-1560198380),_=h(_,p,y,m,u[w+13],21,1309151649),m=h(m,_,p,y,u[w+4],6,-145523070),y=h(y,m,_,p,u[w+11],10,-1120210379),p=h(p,y,m,_,u[w+2],15,718787259),_=h(_,p,y,m,u[w+9],21,-343485551),m=o(m,c),_=o(_,l),p=o(p,d),y=o(y,g);return t(m)+t(_)+t(p)+t(y)}class Handler{constructor(){this._={}}setup(){this.get_node("search-btn").onclick=()=>this.starit(),this.get_node("cancel-btn").onclick=()=>this.refresh(),this.get_node("note-btn").onclick=()=>this.note(),this.get_node("page-cancel-btn").onclick=()=>this.refresh(),this.get_node("save-btn").onclick=()=>this.save(),this.get_node("page-save-btn").onclick=()=>this.save_page(),document.getElementsByName("search-key")[0].addEventListener("keyup",this.search.bind(this)),document.getElementsByName("search-type")[0].addEventListener("change",this.search.bind(this)),this.init()}starit(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{e=e[0];document.getElementsByName("link")[0].value=e.url,document.getElementsByName("page_name")[0].value=e.title,this.hide_node("search"),this.hide_node("login"),this.show_node("starit")})}async init(){var e,t;this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.token=await this.get_token(),this.show_signin(),this.token||(e=GetGithubCode())&&(t=await this.authenticate("github",e),console.log("Authenticating with code ",t,e,this.token),t||ClearGithubCode()),this.token&&(this.show_node("search"),this.hide_signin(),await this.load_data()),this.get_node("info-signin-btn").onclick=()=>this.signin(),this.get_node("info-signout-btn").onclick=()=>this.signout()}async refresh(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),this.token?(this.show_node("search"),this.hide_signin(),await this.load_data()):(this.hide_node("search"),this.show_signin())}async refresh_page(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),this.token?(this.show_node("search"),await this.hide_signin(),await this.search()):(this.hide_node("search"),this.show_signin())}async logout_page(){this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.show_signin()}async load_data(){var e=await this.post(Message.with_token(this.token));return!!e.body.Data&&(this._=e.body.Data.entity,!0)}async authenticate(e,t){try{var n=Message.with_login(e,t);if((await this.post(n)).info.Token)return!0}catch(e){console.log(e)}return!1}show_signin(){this.hide_node("info-signout-btn"),this.show_node("info-signin-btn"),this.hide_node("avatar-img"),this.show_node("avatar-img-gh"),document.getElementById("info-user").innerHTML="Sign in with Github Account",document.getElementById("info-email").innerHTML="Please sign in first."}async hide_signin(){var e=await this.load_profile();e&&(e=JSON.parse(e),document.getElementById("avatar-img").src=e.avatar_url,document.getElementById("info-user").innerHTML=e.login,document.getElementById("info-email").innerHTML=e.email||e.bio||e.location,this.hide_node("avatar-img-gh"),this.hide_node("info-signin-btn"),this.show_node("info-signout-btn"),this.show_node("avatar-img"))}async load_profile(){let e=await this.read_profile();var t;return e||(t=this._code||GetGithubCode())&&(e=await Message.get("https://api.github.com/user",{headers:{Authorization:"token "+t}}),await this.write_profile(e)),e}signin(){OAuth2.loadAdapter("github",this._signin.bind(this))}_signin(){const t=new OAuth2("github",{client_id:"609e41b8b11208bad0f1",client_secret:"052b6d5fec903c262a673c1bfbcb009b6560e039"});t.authorize(()=>{var e=t.getAccessToken();this._code=e,this.load_profile(),this.profile(e)})}async profile(e){let t=!1;try{e&&await this.authenticate("github",e)&&(this._code=e,t=!0,await this.refresh())}catch(e){console.error(e)}t||alert("Failed to signin, please try again!")}async signout(){this.show_signin(),this.set_token(""),this.write_profile(""),this._code="",this.token="",ClearGithubCode(),this.logout_page(),chrome.runtime.sendMessage({signout:!0})}async gh_login(){console.log("Github logging in");var e=chrome.identity.getRedirectURL("gh_cb");console.log(e);const t=new RegExp(e+"[#?](.*)");e={interactive:!0,url:"https://github.com/login/oauth/authorize?client_id=fc69b756691fadc93e10&redirect_uri="+encodeURIComponent(e)};console.log(e),chrome.identity.launchWebAuthFlow(e,e=>{console.log("launchWebAuthFlow completed",chrome.runtime.lastError,e),chrome.runtime.lastError||((e=e.match(t))&&1<e.length?(console.log(t),console.log(parseRedirectFragment(e[1]))):console.log(new Error("Invalid redirect URI")))})}async login(){console.log("logging in");var e=document.getElementsByName("account")[0].value.trim(),t=document.getElementsByName("password")[0].value.trim(),e=Message.with_login(e,t);await this.post(e),await this.refresh()}async save(){var e,t=document.getElementsByName("link")[0].value.trim(),n=document.getElementsByName("page_name")[0].value.trim(),i=document.getElementsByName("category")[0].value.trim(),a=document.getElementsByName("tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);i&&n&&t?((e=Message.with_token(this.token)).actions.push({Put:{id:"",page:{name:n,category:i,content:t,tags:a,page_type:"Link"}}}),(n=await this.post(e)).body.Data&&(this._=n.body.Data.entity,this.refresh_page())):alert("Name/Content/Category can not be null!")}async save_page(){var e=document.getElementsByName("page_content")[0].value.trim();const t=document.getElementsByName("page_title")[0].value.trim();var n,i=document.getElementsByName("page_category")[0].value,a=document.getElementsByName("page_tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);i&&t&&e?((n=Message.with_token(this.token)).actions.push({Put:{id:"",page:{name:t,category:i,content:e,tags:a,page_type:"Note"}}}),(i=await this.post(n)).body.Data&&(this._=i.body.Data.entity,console.log(Object.values(this._.data).filter(e=>e.name==t)),this.refresh_page())):alert("Name/Content/Category can not be null!")}async search(){if(this._.data){window.focus();let t=document.getElementsByName("search-key")[0].value.toLowerCase();if(t){const i=document.getElementsByName("search-type")[0].value,a=t.split(",").map(e=>e.trim()).filter(e=>e);t=a[0];let e;e=1==a.length?e=>{switch(i){case"category":return t==e.category.toLowerCase();case"tag":return e.tags.map(e=>e.toLowerCase()).includes(t);case"name":return e.name.toLowerCase().includes(t);default:return[e.category.toLowerCase(),e.name.toLowerCase(),...e.tags.map(e=>e.toLowerCase())].join("|").includes(t)}}:e=>{const t=[e.category.toLowerCase(),e.name.toLowerCase(),...e.tags.map(e=>e.toLowerCase())].join("|");return a.every(e=>t.includes(e))};var n=Object.values(this._.data).filter(e).map(this.render_msg.bind(this));h.hide_node("search-results"),h.get_node("search-results").replaceChildren(...n),h.show_node("search-results")}}}async post(e){e=await Message.post("https://maester.livefeed.cn",e,{cred:!1}),e=JSON.parse(e);return e&&e.info&&e.info.Token&&(await this.set_token(e.info.Token.token),this.token=e.info.Token.token),e.body.Data&&this.cache_links(e.body.Data),e}async cache_links(e){if(e.entity&&e.entity.data){var t,n=e.entity.data,i={};for(t in n)"Link"==n[t].page_type&&(i[md5(n[t].content)]=1);chrome.storage.local.set(i).then(chrome.runtime.sendMessage(null))}}hide_node(e){this.get_node(e).style.display="none"}show_node(e){this.get_node(e).style.display="flex"}get_node(e){return document.getElementById(e)}render_msg(e){var t=this.get_tpl_item(),n=(t.children[0].children[0].children[0].innerHTML=e.name,t.children[0].children[0].children[1].innerHTML=e.content,t.children[0].children[1].children[0].innerHTML=e.category,e.tags.map(this.render_tag.bind(this)));return t.children[0].children[1].children[1].replaceChildren(...n),t.onclick=()=>{this.open(e)},t}note(){var e={tags:[],name:"",category:"",content:""};document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage")}open(e){console.log("open ",e.content),"Link"==e.page_type?window.open(e.content):(document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage"))}render_tag(e){var t=this.get_tpl_tag();return t.innerHTML=e,t}get_tpl_item(){return document.getElementById("tpl-item").cloneNode(!0)}get_tpl_tag(){return document.getElementById("tpl-tag").cloneNode(!0)}async get_token(){var e=await this.read("maester-key");if(e)return e["maester-key"]}set_token(e){return this.write("maester-key",e)}async read_profile(){var e=await this.read("profile");if(e)return e.profile}write_profile(e){return this.write("profile",e)}write(e,t){var n={};return n[e]=t,_set_local(n)}read(e){return _get_local([e])}}const promisify=n=>(...t)=>new Promise(e=>{t.push(e),n(...t)}),_set_local=promisify(chrome.storage.local.set.bind(chrome.storage.local)),_get_local=promisify(chrome.storage.local.get.bind(chrome.storage.local)),h=new Handler;class Message{static _new(){return{info:"Null",time:0,actions:[],body:"Null"}}static with_login(e,t){var n=Message._new();return n.info={Login:{user:e,pass:t}},n}static with_token(e){var t=Message._new();return t.info={Token:{token:e}},t}static get(a,s={}){return new Promise((e,t)=>{const n=new XMLHttpRequest,i=s.headers;n.open("GET",a),i&&Object.keys(i).forEach(e=>{n.setRequestHeader(e,i[e])}),n.onload=function(){e(n.response)},n.onerror=function(e){t(e)},n.send()})}static post(a,s,o){return new Promise((e,t)=>{const n=new XMLHttpRequest,i=(n.open("POST",a),o.headers);i&&Object.keys(i).forEach(e=>{n.setRequestHeader(e,i[e])}),!1!==o.cred&&(n.withCredentials=!0),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onload=function(){e(o.text?n.responseText:n.response)},n.onerror=function(e){t(e)},n.send(JSON.stringify(s))})}}const GetGithubCode=()=>{var e=localStorage.oauth2_github;try{return(e?JSON.parse(e):{}).accessToken}catch(e){}},ClearGithubCode=()=>{localStorage.oauth2_github="{}"},setup=()=>{console.log("......"),h.setup()};function parseRedirectFragment(e){var e=e.split(/&/),t={};return e.forEach(function(e){e=e.split(/=/);t[e[0]]=e[1]}),t}setup();