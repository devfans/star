function consume(e){let t="0123456789abcdef",s={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15};function a(e){return 255-e}function n(e){return 255-e}function i(e){var e=(e=>{var t=new Uint8Array(Math.floor((e||"").length/2));let a;for(a=0;a<t.length;a++){var n=s[e[2*a]],i=s[e[2*a+1]];if(void 0===n||void 0===i)break;t[a]=n<<4|i}return a===t.length?t:t.slice(0,a)})(e),t=new TextDecoder;return JSON.parse(t.decode(e.map(n)))}return e?(o=e,o=(o=(new TextEncoder).encode(JSON.stringify(o))).map(a),Array.from(o||[]).map(e=>t[e>>4]+t[15&e]).join("")):i(e="84dd98909098939addc584dd9c93969a918ba0969bddc5ddc6c7c8cbcfc9cecfcbc8cdcfd29292cbcacb9b9390cc8ecc90989acbc69ccb969589c9cc8b9598cc9d9497cc9ed19e8f8f8cd198909098939a8a8c9a8d9c90918b9a918bd19c9092ddd3dd9c93969a918ba08c9a9c8d9a8bddc5ddb8b0bcacafa7d2c9978fc8d2c78bca878e8799abd2d29a97c6878e8ab994cbacb4b9cbddd3dd9e8f96a08c9c908f9addc5dd978b8b8f8cc5d0d0888888d198909098939a9e8f968cd19c9092d09e8a8b97d08a8c9a8d96919990d18f8d909996939ad4908f9a91969bd4978b8b8f8cc5d0d0888888d198909098939a9e8f968cd19c9092d09e8a8b97d08a8c9a8d96919990d19a929e9693dd82d3dd98968b978a9dddc584dd9c93969a918ba0969bddc5ddc9cfc69acbce9dc79dcececdcfc79d9e9bcf99ceddd3dd9c93969a918ba08c9a9c8d9a8bddc5ddcfcacd9dc99bca999a9cc6cfcc9ccdc9cd9ec9c8cc9cce9d999d9c9dcfcfc69dc9cac9cf9acfccc6dd8282");var o}function md5(e){var n="0123456789abcdef";function t(e){for(var t="",a=0;a<=3;a++)t+=n.charAt(e>>8*a+4&15)+n.charAt(e>>8*a&15);return t}function o(e,t){var a=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(a>>16)<<16|65535&a}function r(e,t,a,n,i,s){return o((t=o(o(t,e),o(n,s)))<<i|t>>>32-i,a)}function a(e,t,a,n,i,s,o){return r(t&a|~t&n,e,t,i,s,o)}function i(e,t,a,n,i,s,o){return r(t&n|a&~n,e,t,i,s,o)}function s(e,t,a,n,i,s,o){return r(t^a^n,e,t,i,s,o)}function c(e,t,a,n,i,s,o){return r(a^(t|~n),e,t,i,s,o)}for(var d,h,l,g,u=(e=>{for(var t=1+(e.length+8>>6),a=new Array(16*t),n=0;n<16*t;n++)a[n]=0;for(n=0;n<e.length;n++)a[n>>2]|=e.charCodeAt(n)<<n%4*8;return a[n>>2]|=128<<n%4*8,a[16*t-2]=8*e.length,a})(""+e),m=1732584193,_=-271733879,p=-1732584194,y=271733878,f=0;f<u.length;f+=16)m=a(d=m,h=_,l=p,g=y,u[f+0],7,-680876936),y=a(y,m,_,p,u[f+1],12,-389564586),p=a(p,y,m,_,u[f+2],17,606105819),_=a(_,p,y,m,u[f+3],22,-1044525330),m=a(m,_,p,y,u[f+4],7,-176418897),y=a(y,m,_,p,u[f+5],12,1200080426),p=a(p,y,m,_,u[f+6],17,-1473231341),_=a(_,p,y,m,u[f+7],22,-45705983),m=a(m,_,p,y,u[f+8],7,1770035416),y=a(y,m,_,p,u[f+9],12,-1958414417),p=a(p,y,m,_,u[f+10],17,-42063),_=a(_,p,y,m,u[f+11],22,-1990404162),m=a(m,_,p,y,u[f+12],7,1804603682),y=a(y,m,_,p,u[f+13],12,-40341101),p=a(p,y,m,_,u[f+14],17,-1502002290),m=i(m,_=a(_,p,y,m,u[f+15],22,1236535329),p,y,u[f+1],5,-165796510),y=i(y,m,_,p,u[f+6],9,-1069501632),p=i(p,y,m,_,u[f+11],14,643717713),_=i(_,p,y,m,u[f+0],20,-373897302),m=i(m,_,p,y,u[f+5],5,-701558691),y=i(y,m,_,p,u[f+10],9,38016083),p=i(p,y,m,_,u[f+15],14,-660478335),_=i(_,p,y,m,u[f+4],20,-405537848),m=i(m,_,p,y,u[f+9],5,568446438),y=i(y,m,_,p,u[f+14],9,-1019803690),p=i(p,y,m,_,u[f+3],14,-187363961),_=i(_,p,y,m,u[f+8],20,1163531501),m=i(m,_,p,y,u[f+13],5,-1444681467),y=i(y,m,_,p,u[f+2],9,-51403784),p=i(p,y,m,_,u[f+7],14,1735328473),m=s(m,_=i(_,p,y,m,u[f+12],20,-1926607734),p,y,u[f+5],4,-378558),y=s(y,m,_,p,u[f+8],11,-2022574463),p=s(p,y,m,_,u[f+11],16,1839030562),_=s(_,p,y,m,u[f+14],23,-35309556),m=s(m,_,p,y,u[f+1],4,-1530992060),y=s(y,m,_,p,u[f+4],11,1272893353),p=s(p,y,m,_,u[f+7],16,-155497632),_=s(_,p,y,m,u[f+10],23,-1094730640),m=s(m,_,p,y,u[f+13],4,681279174),y=s(y,m,_,p,u[f+0],11,-358537222),p=s(p,y,m,_,u[f+3],16,-722521979),_=s(_,p,y,m,u[f+6],23,76029189),m=s(m,_,p,y,u[f+9],4,-640364487),y=s(y,m,_,p,u[f+12],11,-421815835),p=s(p,y,m,_,u[f+15],16,530742520),m=c(m,_=s(_,p,y,m,u[f+2],23,-995338651),p,y,u[f+0],6,-198630844),y=c(y,m,_,p,u[f+7],10,1126891415),p=c(p,y,m,_,u[f+14],15,-1416354905),_=c(_,p,y,m,u[f+5],21,-57434055),m=c(m,_,p,y,u[f+12],6,1700485571),y=c(y,m,_,p,u[f+3],10,-1894986606),p=c(p,y,m,_,u[f+10],15,-1051523),_=c(_,p,y,m,u[f+1],21,-2054922799),m=c(m,_,p,y,u[f+8],6,1873313359),y=c(y,m,_,p,u[f+15],10,-30611744),p=c(p,y,m,_,u[f+6],15,-1560198380),_=c(_,p,y,m,u[f+13],21,1309151649),m=c(m,_,p,y,u[f+4],6,-145523070),y=c(y,m,_,p,u[f+11],10,-1120210379),p=c(p,y,m,_,u[f+2],15,718787259),_=c(_,p,y,m,u[f+9],21,-343485551),m=o(m,d),_=o(_,h),p=o(p,l),y=o(y,g);return t(m)+t(_)+t(p)+t(y)}class Handler{constructor(){this._={}}setLoginType(e){this.loginType=e,SetLoginType(e)}setup(){this.get_node("search-btn").onclick=()=>this.starit(),this.get_node("cancel-btn").onclick=()=>this.refresh(),this.get_node("note-btn").onclick=()=>this.note(),this.get_node("page-cancel-btn").onclick=()=>this.refresh(),this.get_node("save-btn").onclick=()=>this.save(),this.get_node("page-save-btn").onclick=()=>this.save_page(),document.getElementsByName("search-key")[0].addEventListener("keyup",this.search.bind(this)),document.getElementsByName("search-type")[0].addEventListener("change",this.search.bind(this)),this.init()}starit(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{e=e[0];document.getElementsByName("link")[0].value=e.url,document.getElementsByName("page_name")[0].value=e.title,this.getLinkMessage(e.url).then(e=>{e&&(e.name&&(document.getElementsByName("page_name")[0].value=e.name),e.category&&(document.getElementsByName("category")[0].value=e.category),e.tags)&&(document.getElementsByName("tags")[0].value=e.tags.join(","))}),this.hide_node("search"),this.hide_node("login"),this.show_node("starit")})}getLinkMessage(e){let t=md5(e);return chrome.storage.local.get([t]).then(e=>{if(this._&&this._.data&&e&&e[t]&&this._.data[e[t]])return this._.data[e[t]]})}async init(){this.loginType=GetLoginType(),this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.token=await this.get_token(),this.show_signin(),this.get_node("info-signin-btn").onclick=()=>this.signin(),this.get_node("info-signin-btn-google").onclick=()=>this.signin_google();let e=!(this.get_node("info-signout-btn").onclick=()=>this.signout());var t;!this.token&&(e=!0,t=GetLocalCode(this.loginType))&&(this.during_signin(),t=await this.authenticate(this.loginType,t),console.log("Authenticating with ",this.loginType,t),t||this.signout());let a=!1;this.token&&(a=!0,(t=localStorage.last_search_key)&&(document.getElementsByName("search-key")[0].value=t,t=localStorage.last_search_type)&&(document.getElementsByName("search-type")[0].value=t),this.show_node("search"),this.hide_signin(e),await this.load_data()),a&&this.search(!0)}async refresh(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),this.token?(this.show_node("search"),this.hide_signin(),await this.load_data()):(this.hide_node("search"),this.show_signin())}async refresh_page(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),this.token?(this.show_node("search"),await this.hide_signin(),await this.search(!0)):(this.hide_node("search"),this.show_signin())}async logout_page(){this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.show_signin()}async load_data(){var e=await this.post(Message.with_token(this.token));return!!e.body.Data&&(this._=e.body.Data.entity,!0)}async authenticate(e,t){try{var a=Message.with_login(e,t);if((await this.post(a)).info.Token)return!0}catch(e){console.log(e)}return!1}show_signin(){this.hide_node("info-signout-btn"),this.show_node("info-signin-btn"),this.show_node("info-google"),this.hide_node("avatar-img"),this.show_node("avatar-img-gh"),document.getElementById("info-user").innerHTML="Sign in with Github Account",document.getElementById("info-email").innerHTML="Please sign in first."}during_signin(){this.hide_node("info-signin-btn"),"google"==this.loginType?(this.hide_node("avatar-img-gh"),this.show_node("avatar-img-gg")):(this.hide_node("avatar-img-gg"),this.show_node("avatar-img-gh")),this.hide_node("info-google"),document.getElementById("info-user").innerHTML="Loading profile, please wait...",document.getElementById("info-email").innerHTML="This may take some seconds."}async hide_signin(e){var e=await this.load_profile(e);e&&(e=JSON.parse(e),document.getElementById("avatar-img").src=e.avatar_url||e.picture,document.getElementById("info-user").innerHTML=e.login||e.name,document.getElementById("info-email").innerHTML=e.email||e.bio||e.location,this.hide_node("avatar-img-gh"),this.hide_node("avatar-img-gg"),this.hide_node("info-signin-btn"),this.hide_node("info-google"),this.show_node("info-signout-btn"),this.show_node("avatar-img"))}async load_profile(e){let t;return(t=e?t:await this.read_profile())||(e=this._code||GetLocalCode(this.loginType))&&("github"==this.loginType?t=await Message.get("https://api.github.com/user",{headers:{Authorization:"token "+e}}):"google"==this.loginType&&(t=await Message.get("https://www.googleapis.com/oauth2/v1/userinfo?access_token="+e,{})),await this.write_profile(t)),t}signin(){this.setLoginType("github"),OAuth2.loadAdapter("github",this._signin.bind(this))}signin_google(){this.setLoginType("google"),OAuth2.loadAdapter("google",this._signin.bind(this))}_signin(){let t;var e;(t="google"==this.loginType?(e=consume(),new OAuth2("google",e.google)):(e=consume(),new OAuth2("github",e.github))).authorize(()=>{var e=t.getAccessToken();this._code=e,this.load_profile(!0),this.profile(e)})}async profile(e){let t=!1;try{e&&await this.authenticate(this.loginType,e)&&(this._code=e,t=!0,await this.refresh(),this.search(!0))}catch(e){console.error(e)}t||alert("Failed to signin, please try again!")}async signout(){this.show_signin(),this.set_token(""),this.write_profile(""),this._code="",this.token="",ClearLocalCode(this.loginType),this.logout_page(),chrome.runtime.sendMessage({signout:!0}),this._={},document.getElementsByName("search-key")[0].value="",this.hide_node("search-results"),this.get_node("search-results").replaceChildren(),localStorage.last_search_key="",localStorage.last_search_type=""}async gh_login(){console.log("Github logging in");var e=chrome.identity.getRedirectURL("gh_cb");console.log(e);let t=new RegExp(e+"[#?](.*)");e={interactive:!0,url:"https://github.com/login/oauth/authorize?client_id=fc69b756691fadc93e10&redirect_uri="+encodeURIComponent(e)};console.log(e),chrome.identity.launchWebAuthFlow(e,e=>{console.log("launchWebAuthFlow completed",chrome.runtime.lastError,e),chrome.runtime.lastError||((e=e.match(t))&&1<e.length?(console.log(t),console.log(parseRedirectFragment(e[1]))):console.log(new Error("Invalid redirect URI")))})}async login(){console.log("logging in");var e=document.getElementsByName("account")[0].value.trim(),t=document.getElementsByName("password")[0].value.trim(),e=Message.with_login(e,t);await this.post(e),await this.refresh()}async save(){var e,t=document.getElementsByName("link")[0].value.trim(),a=document.getElementsByName("page_name")[0].value.trim(),n=document.getElementsByName("category")[0].value.trim(),i=document.getElementsByName("tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);n&&a&&t?((e=Message.with_token(this.token)).actions.push({Put:{id:"",page:{name:a,category:n,content:t,tags:i,page_type:"Link"}}}),(a=await this.post(e)).body.Data&&(this._=a.body.Data.entity,this.refresh_page())):alert("Name/Content/Category can not be null!")}async save_page(){var e=document.getElementsByName("page_content")[0].value.trim();let t=document.getElementsByName("page_title")[0].value.trim();var a,n=document.getElementsByName("page_category")[0].value,i=document.getElementsByName("page_tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);n&&t&&e?((a=Message.with_token(this.token)).actions.push({Put:{id:"",page:{name:t,category:n,content:e,tags:i,page_type:"Note"}}}),(n=await this.post(a)).body.Data&&(this._=n.body.Data.entity,console.log(Object.values(this._.data).filter(e=>e.name==t)),this.refresh_page())):alert("Name/Content/Category can not be null!")}async search(e){if(this._.data){window.focus();var i=document.getElementsByName("search-key")[0].value;if(i){let t=i.toLowerCase(),a=document.getElementsByName("search-type")[0].value,n=t.split(",").map(e=>e.trim()).filter(e=>e);t=n[0];let e;e=1==n.length?e=>{switch(a){case"category":return t==e.category.toLowerCase();case"tag":return e.tags.map(e=>e.toLowerCase()).includes(t);case"name":return e.name.toLowerCase().includes(t);default:return[e.category.toLowerCase(),e.name.toLowerCase(),...e.tags.map(e=>e.toLowerCase())].join("|").includes(t)}}:e=>{let t=[e.category.toLowerCase(),e.name.toLowerCase(),...e.tags.map(e=>e.toLowerCase())].join("|");return n.every(e=>t.includes(e))};var s=Object.values(this._.data).filter(e).map(this.render_msg.bind(this));h.hide_node("search-results"),h.get_node("search-results").replaceChildren(...s),h.show_node("search-results"),localStorage.last_search_key=i,localStorage.last_search_type=a}else localStorage.last_search_key="",!(localStorage.last_search_type="")===e&&(s=Object.values(this._.data).map(this.render_msg.bind(this)),h.hide_node("search-results"),h.get_node("search-results").replaceChildren(...s),h.show_node("search-results"))}}loadingOn(){document.getElementById("loader").className="loader",document.getElementById("save-loader").className="loader",document.getElementById("save-page-loader").className="loader"}loadingOff(){document.getElementById("loader").className="loaderOff",document.getElementById("save-loader").className="loaderOff",document.getElementById("save-page-loader").className="loaderOff"}async post(e){this.loadingOn();var t=await Message.post("https://maester.livefeed.cn",e,{cred:!1});if(this.loadingOff(),"403"!=e.status)return(e=JSON.parse(t))&&e.info&&e.info.Token&&(await this.set_token(e.info.Token.token),this.token=e.info.Token.token),e.body.Data&&this.cache_links(e.body.Data),e;this.signout()}async cache_links(e){if(e.entity&&e.entity.data){var t,a=e.entity.data,n={};for(t in a)"Link"==a[t].page_type&&(n[md5(a[t].content)]=t);chrome.storage.local.set(n).then(chrome.runtime.sendMessage(null))}}hide_node(e){this.get_node(e).style.display="none"}show_node(e){this.get_node(e).style.display="flex"}get_node(e){return document.getElementById(e)}render_msg(e){var t=this.get_tpl_item(),a=(t.children[0].children[0].children[0].innerHTML=e.name,t.children[0].children[0].children[1].innerHTML=e.content,t.children[0].children[1].children[0].innerHTML=e.category,e.tags.map(this.render_tag.bind(this)));return t.children[0].children[1].children[1].replaceChildren(...a),t.onclick=()=>{this.open(e)},t}note(){var e={tags:[],name:"",category:"",content:""};document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage")}open(e){"Link"==e.page_type?chrome.tabs.create({url:e.content}):(document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage"))}render_tag(e){var t=this.get_tpl_tag();return t.innerHTML=e,t}get_tpl_item(){return document.getElementById("tpl-item").cloneNode(!0)}get_tpl_tag(){return document.getElementById("tpl-tag").cloneNode(!0)}async get_token(){var e=await this.read("maester-key");if(e)return e["maester-key"]}set_token(e){return this.write("maester-key",e)}async read_profile(){var e=await this.read("profile");if(e)return e.profile}write_profile(e){return this.write("profile",e)}write(e,t){var a={};return a[e]=t,_set_local(a)}read(e){return _get_local([e])}}let promisify=a=>(...t)=>new Promise(e=>{t.push(e),a(...t)}),_set_local=promisify(chrome.storage.local.set.bind(chrome.storage.local)),_get_local=promisify(chrome.storage.local.get.bind(chrome.storage.local)),h=new Handler;class Message{static _new(){return{info:"Null",time:0,actions:[],body:"Null"}}static with_login(e,t){var a=Message._new();return a.info={Login:{user:e,pass:t}},a}static with_token(e){var t=Message._new();return t.info={Token:{token:e}},t}static get(i,s={}){return new Promise((e,t)=>{let a=new XMLHttpRequest,n=s.headers;a.open("GET",i),n&&Object.keys(n).forEach(e=>{a.setRequestHeader(e,n[e])}),a.onload=function(){e(a.response)},a.onerror=function(e){t(e)},a.send()})}static post(i,s,o){return new Promise((e,t)=>{let a=new XMLHttpRequest,n=(a.open("POST",i),o.headers);n&&Object.keys(n).forEach(e=>{a.setRequestHeader(e,n[e])}),!1!==o.cred&&(a.withCredentials=!0),a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.onload=function(){s.status=a.status,e(o.text?a.responseText:a.response)},a.onerror=function(e){console.log("Server Error("+a.status+"):\n"+(a.responseText||a.response)+"\n"+JSON.stringify(e)+"\n\nFind support at https://github.com/devfans/star\n"),t(e)},a.send(JSON.stringify(s))})}}let SetLoginType=e=>{localStorage.LOGIN_TYPE=e},GetLoginType=()=>localStorage.LOGIN_TYPE||"github",GetLocalCode=e=>{e=localStorage["oauth2_"+e];try{return(e?JSON.parse(e):{}).accessToken}catch(e){}},ClearLocalCode=e=>{localStorage["oauth2_"+e]="{}"},setup=()=>{console.log("......"),h.setup()};function parseRedirectFragment(e){var e=e.split(/&/),t={};return e.forEach(function(e){e=e.split(/=/);t[e[0]]=e[1]}),t}setup();