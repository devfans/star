"use strict";class Handler{constructor(){this._={}}setup(){this.get_node("search-btn").onclick=(()=>this.starit()),this.get_node("cancel-btn").onclick=(()=>this.refresh()),this.get_node("note-btn").onclick=(()=>this.note()),this.get_node("page-cancel-btn").onclick=(()=>this.refresh()),this.get_node("save-btn").onclick=(()=>this.save()),this.get_node("page-save-btn").onclick=(()=>this.save_page()),document.getElementsByName("search-key")[0].addEventListener("keyup",this.search.bind(this)),document.getElementsByName("search-type")[0].addEventListener("change",this.search.bind(this)),this.init()}starit(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},e=>{const t=e[0];console.log(t),document.getElementsByName("link")[0].value=t.url,document.getElementsByName("page_name")[0].value=t.title,this.hide_node("search"),this.hide_node("login"),this.show_node("starit")})}async init(){if(this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.token=await this.get_token(),this.show_signin(),!this.token){const e=GetGithubCode();if(e){const t=await this.authenticate("github",e);console.log("Authenticating with code ",t,e,this.token),t||ClearGithubCode()}}this.token&&(this.show_node("search"),this.hide_signin(),await this.load_data()),this.get_node("info-signin-btn").onclick=(()=>this.signin()),this.get_node("info-signout-btn").onclick=(()=>this.signout())}async refresh(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),this.token?(this.show_node("search"),this.hide_signin(),await this.load_data()):(this.hide_node("search"),this.show_signin())}async refresh_page(){this.hide_node("starit"),this.hide_node("starpage"),this.token=await this.get_token(),console.log(this.token),this.token?(this.show_node("search"),await this.hide_signin(),await this.search()):(this.hide_node("search"),this.show_signin())}async logout_page(){this.hide_node("starit"),this.hide_node("starpage"),this.hide_node("search"),this.show_signin()}async load_data(){const e=await this.post(Message.with_token(this.token));return!!e.body.Data&&(this._=e.body.Data.entity,!0)}async authenticate(e,t){try{const n=Message.with_login(e,t);if((await this.post(n)).info.Token)return!0}catch(e){console.log(e)}return!1}show_signin(){this.hide_node("info-signout-btn"),this.show_node("info-signin-btn"),this.hide_node("avatar-img"),this.show_node("avatar-img-gh"),document.getElementById("info-user").innerHTML="Sign in with Github Account",document.getElementById("info-email").innerHTML="Please sign in first."}async hide_signin(){const e=await this.load_profile();if(e){const t=JSON.parse(e);document.getElementById("avatar-img").src=t.avatar_url,document.getElementById("info-user").innerHTML=t.login,document.getElementById("info-email").innerHTML=t.email,this.hide_node("avatar-img-gh"),this.hide_node("info-signin-btn"),this.show_node("info-signout-btn"),this.show_node("avatar-img")}}async load_profile(){let e=await this.read_profile();if(!e){const t=this._code||GetGithubCode();t&&(e=await Message.get("https://api.github.com/user",{headers:{Authorization:"token "+t}}),await this.write_profile(e))}return e}signin(){OAuth2.loadAdapter("github",this._signin.bind(this))}_signin(){const e=new OAuth2("github",{client_id:"609e41b8b11208bad0f1",client_secret:"052b6d5fec903c262a673c1bfbcb009b6560e039"});e.authorize(()=>{const t=e.getAccessToken();this._code=t,this.load_profile(),this.profile(t)})}async profile(e){let t=!1;try{e&&await this.authenticate("github",e)&&(this._code=e,t=!0,await this.refresh())}catch(e){console.error(e)}t||alert("Failed to signin, please try again!")}async signout(){this.show_signin(),this.set_token(""),this.write_profile(""),this._code="",this.token="",ClearGithubCode(),this.logout_page(),chrome.runtime.sendMessage({signout:!0})}async gh_login(){console.log("Github logging in");const e=chrome.identity.getRedirectURL("gh_cb");console.log(e);const t=new RegExp(e+"[#?](.*)"),n={interactive:!0,url:"https://github.com/login/oauth/authorize?client_id=fc69b756691fadc93e10&redirect_uri="+encodeURIComponent(e)};console.log(n),chrome.identity.launchWebAuthFlow(n,e=>{if(console.log("launchWebAuthFlow completed",chrome.runtime.lastError,e),chrome.runtime.lastError)return;const n=e.match(t);n&&n.length>1?(console.log(t),console.log(parseRedirectFragment(n[1]))):console.log(new Error("Invalid redirect URI"))})}async login(){console.log("logging in");const e=document.getElementsByName("account")[0].value.trim(),t=document.getElementsByName("password")[0].value.trim(),n=Message.with_login(e,t);await this.post(n),await this.refresh()}async save(){const e=document.getElementsByName("link")[0].value.trim(),t=document.getElementsByName("page_name")[0].value.trim(),n=document.getElementsByName("category")[0].value.trim(),s=document.getElementsByName("tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);if(n&&t&&e){const i=Message.with_token(this.token);i.actions.push({Put:{id:"",page:{name:t,category:n,content:e,tags:s,page_type:"Link"}}});const o=await this.post(i);o.body.Data&&(this._=o.body.Data.entity,this.refresh_page())}else alert("Name/Content/Category can not be null!")}async save_page(){const e=document.getElementsByName("page_content")[0].value.trim(),t=document.getElementsByName("page_title")[0].value.trim(),n=document.getElementsByName("page_category")[0].value,s=document.getElementsByName("page_tags")[0].value.split(",").map(e=>e.trim()).filter(e=>e);if(n&&t&&e){const i=Message.with_token(this.token);i.actions.push({Put:{id:"",page:{name:t,category:n,content:e,tags:s,page_type:"Note"}}});const o=await this.post(i);o.body.Data&&(this._=o.body.Data.entity,console.log(Object.values(this._.data).filter(e=>e.name==t)),this.refresh_page())}else alert("Name/Content/Category can not be null!")}async search(){if(this._.data){window.focus();let e=document.getElementsByName("search-key")[0].value.toLowerCase();if(!e)return;const t=document.getElementsByName("search-type")[0].value,n=e.split(",").map(e=>e.trim()).filter(e=>e);let s;e=n[0],s=1==n.length?n=>{switch(t){case"category":return e==n.category.toLowerCase();case"tag":return n.tags.map(e=>e.toLowerCase()).includes(e);case"name":return n.name.toLowerCase().includes(e);default:return[n.category.toLowerCase(),n.name.toLowerCase(),...n.tags.map(e=>e.toLowerCase())].join("|").includes(e)}}:e=>{const t=[e.category.toLowerCase(),e.name.toLowerCase(),...e.tags.map(e=>e.toLowerCase())].join("|");return n.every(e=>t.includes(e))};const i=Object.values(this._.data).filter(s).map(this.render_msg.bind(this));h.hide_node("search-results"),h.get_node("search-results").replaceChildren(...i),h.show_node("search-results")}}async post(e){const t=await Message.post("https://maester.livefeed.cn",e,{cred:!1}),n=JSON.parse(t);return n&&n.info&&n.info.Token&&(await this.set_token(n.info.Token.token),this.token=n.info.Token.token),n.body.Data&&chrome.runtime.sendMessage(n.body.Data),n}hide_node(e){this.get_node(e).style.display="none"}show_node(e){this.get_node(e).style.display="flex"}get_node(e){return document.getElementById(e)}render_msg(e){const t=this.get_tpl_item();t.children[0].children[0].children[0].innerHTML=e.name,t.children[0].children[0].children[1].innerHTML=e.content,t.children[0].children[1].children[0].innerHTML=e.category;const n=e.tags.map(this.render_tag.bind(this));return t.children[0].children[1].children[1].replaceChildren(...n),t.onclick=(()=>{this.open(e)}),t}note(){const e={tags:[],name:"",category:"",content:""};document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage")}open(e){console.log("open ",e.content),"Link"==e.page_type?window.open(e.content):(document.getElementsByName("page_title")[0].value=e.name,document.getElementsByName("page_content")[0].value=e.content,document.getElementsByName("page_category")[0].value=e.category,document.getElementsByName("page_tags")[0].value=e.tags.join(","),this.hide_node("starit"),this.hide_node("search"),this.hide_node("login"),this.show_node("starpage"))}render_tag(e){const t=this.get_tpl_tag();return t.innerHTML=e,t}get_tpl_item(){return document.getElementById("tpl-item").cloneNode(!0)}get_tpl_tag(){return document.getElementById("tpl-tag").cloneNode(!0)}async get_token(){const e=await this.read("maester-key");if(e)return e["maester-key"]}set_token(e){return this.write("maester-key",e)}async read_profile(){const e=await this.read("profile");if(e)return e.profile}write_profile(e){return this.write("profile",e)}write(e,t){const n={};return n[e]=t,_set_local(n)}read(e){return _get_local([e])}}const promisify=e=>(...t)=>new Promise(n=>{t.push(n),e(...t)}),_set_local=promisify(chrome.storage.local.set.bind(chrome.storage.local)),_get_local=promisify(chrome.storage.local.get.bind(chrome.storage.local)),h=new Handler;class Message{static _new(){return{info:"Null",time:0,actions:[],body:"Null"}}static with_login(e,t){const n=Message._new();return n.info={Login:{user:e,pass:t}},n}static with_token(e){const t=Message._new();return t.info={Token:{token:e}},t}static get(e,t={}){return new Promise((n,s)=>{const i=new XMLHttpRequest,o=t.headers;i.open("GET",e),o&&Object.keys(o).forEach(e=>{i.setRequestHeader(e,o[e])}),i.onload=function(){n(i.response)},i.onerror=function(e){s(e)},i.send()})}static post(e,t,n){return new Promise((s,i)=>{const o=new XMLHttpRequest;o.open("POST",e);const a=n.headers;a&&Object.keys(a).forEach(e=>{o.setRequestHeader(e,a[e])}),!1!==n.cred&&(o.withCredentials=!0),o.setRequestHeader("Content-Type","application/json;charset=UTF-8"),o.onload=function(){s(n.text?o.responseText:o.response)},o.onerror=function(e){i(e)},console.log("sending"),console.log(t),o.send(JSON.stringify(t))})}}const GetGithubCode=()=>{const e=localStorage.oauth2_github;try{return(e?JSON.parse(e):{}).accessToken}catch(e){}},ClearGithubCode=()=>{localStorage.oauth2_github="{}"},setup=()=>{console.log("......"),h.setup()};function parseRedirectFragment(e){var t={};return e.split(/&/).forEach(function(e){var n=e.split(/=/);t[n[0]]=n[1]}),t}console.log("......"),h.setup();